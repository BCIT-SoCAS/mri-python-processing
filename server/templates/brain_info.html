<!DOCTYPE html>

<html>
    <head>
        <title>MHA Brain Information</title>
        <meta charset="utf-8">
    </head>
    <body>
           
        <!-- div for axial profile -->
        <div>
            <h3>AXIAL</h3>
            <canvas id="top_view"></canvas>
            <input type="range" class="slider" id="top_view_slider">
            <label for='top_view_index'>index</label><input type="text" id='top_view_index'/>
        </div>

        <!-- div for sagittal profile -->
        <div>
            <h3>SAGITTAL</h3>
            <canvas id="side_view"></canvas>
            <input type="range" class="slider" id="side_view_slider">
            <label for='side_view_index'>index</label><input type="text" id='side_view_index'/>
            
        </div>

        <!-- div for coronoal profile -->
        <div>
            <h3>CORONAL</h3>
            <canvas id="front_view"></canvas>
            <input type="range" class="slider" id="front_view_slider">
            <label for='front_view_index'>index</label><input type="text" id='front_view_index'/>
            
        </div>

        <fieldset>
            <legend>Pre processing</legend>
            <input type='button' value='Median Filter'/>
            <input type='button' value='Histogram EQ' />
            <input type='button' value='Bilateral Filter' />
            <input type='button' value='Strip Skull' />
        </fieldset>

        <fieldset>
            <legend>Segmentation</legend>
            <input type='button' value='Locate Marker'/>
            <input type='button' value='Show Local Gradient' />
            <input type='button' value='Apply Watershed' />
        </fieldset>

        <fieldset>
            <legend>Tumor Detection</legend>
            <input type='button' value='Detect Tumor'/>
            
        </fieldset>
        
        <script>
           
            // TODO i'd like to separate this to brain.js
            // create a model
            var brain_model = {
                data: [],
                loadData: function(data) {
                    this.data = data

                    this.views.top.slider.max = data.length -1;
                    this.views.front.slider.max = data[0].length - 1;
                    this.views.side.slider.max = data[0][0].length - 1;

                    // default value would be the middle
                    this.views.top.slider.value = Math.floor((data.length - 1) / 2);
                    this.views.front.slider.value = Math.floor(data[0].length / 2);
                    this.views.side.slider.value = Math.floor(data[0][0].length / 2);

                    this.views.top.index.value = this.views.top.slider.value;
                    this.views.front.index.value = this.views.front.slider.value;
                    this.views.side.index.value = this.views.side.slider.value;

                    this.views.redraw();

                },
                getSlice: function(type="top", index) {
                    
                    brain = this.data
                    if(type === 'top') {
                        if(index >= brain.length) {
                            index = brain.length - 1;
                        }

                        if(index < 0) {
                            index = 0
                        }
                        
                        return this.data[index]
                    } 
                    else if(type === 'side')
                    {
                        result = [];
                        
                        // check out of bounds
                        if (index >= brain[0][0].length) {
                            index = brain[0][0].length - 1
                        }

                        if (index < 0) {
                            index = 0;
                        }

                        for(var x = 0 ; x < brain.length; x++) {
                            temp_array = []
                            for(var y= 0; y < brain[x].length; y++)
                            {
                                temp_array.push(brain[x][y][index])
                            }
                            result.push(temp_array)
                        }
                        return result;
                    } 
                    else if(type === 'front') {
                        
                        result = [];

                        for(var x = 0; x < brain.length ; x++) {
                            result.push(brain[x][index])
                        }
                        return result;
                    }
                    return []
                },
                views: {
                    redraw: function() {
                        this.top.draw()
                        this.side.draw()
                        this.front.draw()
                    },
                    top: {
                        canvas: document.getElementById('top_view'),
                        slider: document.getElementById('top_view_slider'),
                        index: document.getElementById('top_view_index'),
                        draw: function() {
                            this.canvas.draw(brain_model.getSlice('top', this.slider.value), 'grayscale')
                        }
                    },

                    side: {
                        canvas: document.getElementById('side_view'),
                        slider: document.getElementById('side_view_slider'),
                        index: document.getElementById('side_view_index'),
                        draw: function() {
                            this.canvas.draw(brain_model.getSlice('side', this.slider.value), 'grayscale', true, true);
                        }
                    },
                    
                    front: {
                        canvas: document.getElementById('front_view'),
                        slider: document.getElementById('front_view_slider'),
                        index: document.getElementById('front_view_index'),
                        draw: function() {
                            this.canvas.draw(brain_model.getSlice('front', this.slider.value), 'grayscale', true)
                        }
                    }
                },
                init: function() {
                    var views = this.views
                    for(var view in views) {
                        if (views.hasOwnProperty(view)) {
                            if(views[view].hasOwnProperty('canvas'))
                            {
                                this.attach_properties(views[view])
                            }
                        }
                    }
                },
                attach_properties: function(view){

                    view.canvas.draw = draw;  
                    view.slider.addEventListener('change', function(){
                        view.index.value = this.value;
                        view.draw()
                    })                  
                }
                
            }
            
            // this applies to canvas
            // type could be RGB | grayscale
            // separate this function, i could reuse this for the output view
            function draw(img_array, type='RGB', flipx=false, flipy=false) {
               
                var ctx = this.getContext('2d');
                
                var startx = (flipx)? img_array.length - 1 : 0;
                var endx = (flipx)? 0 : img_array.length - 1;
                var stepx = (flipx)? -1 : 1;

                var starty = (flipy)? img_array[0].length - 1 : 0;
                var endy = (flipy)? 0 : img_array[0].length -1;
                var stepy = (flipy)? -1 : 1;

                if(type === 'grayscale') {
                    for (i=startx, x=0; i != endx; i+=stepx, x++){
                        for(j=starty, y=0; j != endy;j+=stepy, y++){
                            var color = img_array[i][j]
                            ctx.fillStyle = "rgb("+color+","+color+","+color+")";
                            ctx.fillRect(y, x, 1, 1);
                        }
                    }
                } 
                else if (type === 'RGB') {

                }
            }

            function main(){

                data = {{brain.data}};
                dim = {{brain.dim}};
                
                brain_model.init();
                brain_model.loadData(data);
            }

           
            main();
        
        </script>
    </body>
 </html>