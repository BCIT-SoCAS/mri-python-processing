<!DOCTYPE html>
<html>
    <head>
        <title>MRI Project</title>
        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}"/>
        <link rel="stylesheet" type="text/css" href="../static/css/index.css"/>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>
    
    <body>
        <div id="view">
            <div id="move" class="container-fluid holder1">

                <div id="display" class="row">
                    <button class="next btn btn-light" type="button" id="to_preprocess">Next</button>

                    <div id="img_display" class="container-fluid col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">
                        <div class="row a">
                            <label class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 row">Coronal</label>
                        </div>
                        
                        <div class="img">
                             <canvas class="canvas1" id="c1"></canvas>
                        </div>

                        <div id="a">
                            <input type="range" class="slider" id="myRange">

                            <label id="sn">Slice Number: 
                                <input type="number" name="slice_num" placeholder="Slice Number" class="input" id="num" min="0"><br>
                            </label>
                        </div>
                    </div>
                    
                    <div id="img_display" class="container-fluid col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">
                        <div class="row a">
                            <label class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 row">Sagittal</label>
                        </div>
                        
                        <div class="img">
                             <canvas class="canvas1" id="c1"></canvas>
                        </div>

                        <div id="a">
                            <input type="range" class="slider" id="myRange">

                            <label id="sn">Slice Number: 
                                <input type="number" name="slice_num" placeholder="Slice Number" class="input" id="num" min="0"><br>
                            </label>
                        </div>
                    </div>
                    
                    <div id="img_display" class="container-fluid col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">
                        <div class="row a">
                            <label class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 row">Axial</label>
                        </div>
                        
                        <div class="img">
                             <canvas class="canvas1" id="c1"></canvas>
                        </div>

                        <div id="a">
                            <input type="range" class="slider" id="myRange">

                            <label id="sn">Slice Number: 
                                <input type="number" name="slice_num" placeholder="Slice Number" class="input" id="num" min="0"><br>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="pre" class="row">
                    <button class="back btn btn-light" type="button" id="to_view">Back</button>
                    <button class="next btn btn-light" type="button" id="to_seg">Next</button>
                    
                    <div id="options" class="container-fluid col-xl-7 col-lg-7 col-md-7 col-sm-7 col-xs-7">
                        <div class="row a">
                            <label class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">Pre-Processing</label>
                        </div>
                        
                        <div class="row a prep">
                            <div class="img">
                                 <canvas class="canvas1" id="c2"></canvas>
                            </div>

                            <div class="btn-group col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" role="group">
                                <button id="skullStrip" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Skull Stripping</button>    
                                <button id="isolate" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Isolate Brain</button>
                                <button id="median" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Median Filter</button>
                            </div>

                            <div class="btn-group col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12" role="group">
                                <button id="bilateral" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Bilateral Filter</button>    
                                <button id="histEQ" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Histogram EQ</button>
                                <button id="reset" type="button" class="btn btn-light col-xl-4 col-lg-4 col-md-4 col-sm-4 col-xs-4">Reset</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-5 col-lg-5 col-md-5 col-sm-5 col-xs-5" id="desc">
                        Blah blah blahBlah Blah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blah
                        Blah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah 
                        blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah
                        blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blah
                        Blah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah 
                        blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah 
                        blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blah
                        Blah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah 
                        blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah 
                        blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blah
                        Blah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah blahBlah 
                        blah blahBlah blah blahBlah blah blahBlah blah blahBlah blah
                    </div>
                </div>

                <div id="seg" class="row">
                    <button class="back btn btn-light" type="button" id="to_pre">Back</button>

                    <div id="img_display" class="container-fluid col-xl-12 col-lg-12 col-md-12 col-sm-12">
                        <div class="row a">
                            <label class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">Segmentation</label>
                        </div>
                        
                        <div class="img">
                             <canvas class="canvas1" id="c3"></canvas>
                        </div>

                        <div class="row a">
                            <button id="watershed_button" type="button" class="btn btn-light">Apply Watershed</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            var move = document.getElementById("move");
            var next = document.getElementsByClassName("next");
            var back = document.getElementsByClassName("back");

            function doAThing(index) {
                move.style.top = `-${index*window.innerHeight}px`;
            }

            for (let x = 0; x < next.length; x++) {
                next[x].onclick = function() {
                    doAThing(x + 1);
                }

                back[x].onclick = function() {
                    doAThing(x);
                }
            }

//            // TODO i'd like to separate this to brain.js
//            // Create a model
//            var brain_model = {
//                data: [],
//                currentView: null,
//                loadData: function(data) {
//                    this.data = data;
//
//                    this.views.top.slider.max = data.length - 1;
//                    this.views.front.slider.max = data[0].length - 1;
//                    this.views.side.slider.max = data[0][0].length - 1;
//
//                    // Default value would be the middle
//                    this.views.top.slider.value = Math.floor((data.length - 1) / 2);
//                    this.views.front.slider.value = Math.floor(data[0].length / 2);
//                    this.views.side.slider.value = Math.floor(data[0][0].length / 2);
//
//                    this.views.top.index.value = this.views.top.slider.value;
//                    this.views.front.index.value = this.views.front.slider.value;
//                    this.views.side.index.value = this.views.side.slider.value;
//
//                    this.views.redraw();
//                },
//                getSlice: function(type="top", index) {
//                    brain = this.data;
//                    
//                    if(type === 'top') {
//                        if(index >= brain.length) {
//                            index = brain.length - 1;
//                        }
//
//                        if(index < 0) {
//                            index = 0;
//                        }
//                        
//                        return this.data[index];
//                    } 
//                    
//                    else if(type === 'side') {
//                        result = [];
//                        
//                        // Check out of bounds
//                        if (index >= brain[0][0].length) {
//                            index = brain[0][0].length - 1;
//                        }
//
//                        if (index < 0) {
//                            index = 0;
//                        }
//
//                        for(var x = 0 ; x < brain.length; x++) {
//                            temp_array = []
//                            for(var y= 0; y < brain[x].length; y++) {
//                                temp_array.push(brain[x][y][index]);
//                            }
//                            result.push(temp_array);
//                        }
//                        
//                        return result;
//                    } 
//                    
//                    else if(type === 'front') {
//                        result = [];
//
//                        for(var x = 0; x < brain.length ; x++) {
//                            result.push(brain[x][index]);
//                        }
//                        
//                        return result;
//                    }
//                    
//                    return []
//                },
//                views: {
//                    redraw: function() {
//                        this.top.draw();
//                        this.side.draw();
//                        this.front.draw();
//                    },
//                    top: {
//                        canvas: document.getElementById('c1'),
//                        slider: document.getElementById('myRange'),
//                        index: document.getElementById('num'),
//                        select: document.getElementById('top_view_select'),
//                        draw: function() {
//                            this.canvas.draw(brain_model.getSlice('top', this.slider.value), 'grayscale');
//                        }
//                    },
//
//                    side: {
//                        canvas: document.getElementById('side_view'),
//                        slider: document.getElementById('side_view_slider'),
//                        index: document.getElementById('side_view_index'),
//                        select: document.getElementById('side_view_select'),
//                        draw: function() {
//                            this.canvas.draw(brain_model.getSlice('side', this.slider.value), 'grayscale', true, true);
//                        }
//                    },
//                    
//                    front: {
//                        canvas: document.getElementById('front_view'),
//                        slider: document.getElementById('front_view_slider'),
//                        index: document.getElementById('front_view_index'),
//                        select: document.getElementById('front_view_select'),
//                        draw: function() {
//                            this.canvas.draw(brain_model.getSlice('front', this.slider.value), 'grayscale', true);
//                        }
//                    }
//                },
//                init: function() {
//                    var views = this.views;
//                    
//                    for(var view in views) {
//                        if (views.hasOwnProperty(view)) {
//                            if(views[view].hasOwnProperty('canvas')) {
//                                this.attach_properties(views[view], view);
//                            }
//                        }
//                    }
//                },
//                attach_properties: function(view, view_name){
//                    view.canvas.draw = draw;
//                    
//                    view.slider.addEventListener('change', function(event) {
//                        view.index.value = this.value;
//                        view.draw()
//                    });
//                    
//                    view.select.addEventListener('click', function(event) {
//                        flipx = (view_name === 'side' || view_name ==='front')? true: false;
//                        flipy = (view_name === 'side')? true : false;
//                        brain_model.currentView = view_name;
//                        postRequest('/setPreprocessImage', {
//                            view:view_name, 
//                            index:view.slider.value
//                        })
//                        .then(response => response.json())
//                        .then(data => {
//                            pre_process_out.draw(data,'grayscale', flipx, flipy);
//                        })
//                        .catch(err => console.log(err));
//                    });
//                }
//            }
//
//            // This applies to canvas
//            // Type could be RGB | grayscale
//            // Separate this function, i could reuse this for the output view
//            // lol, flipx shoud be flipy and vice versa but im too lazy to change
//
//            function initPreprocessingFields() {
//
//                // init the output canvas
//                pre_process_out = document.getElementById('pre_process_out');
//                pre_process_out.draw = draw
//                
//                //add event listener to buttons
//                median_filter = document.getElementById('median_filter');
//                histo_filter = document.getElementById('histo_filter');
//                bilateral_filter = document.getElementById('bilateral_filter');
//                reset_filters = document.getElementById('reset_filters')
//                isolate_brain = document.getElementById('isolate_brain');
//
//                filters_list = document.getElementById('filters_list');
//
//                function updatePreprocessCanvas(data,flipx,flipy) {
//                    pre_process_out.draw(data,'grayscale',flipx,flipy)
//                }
//                
//                function addToFiltersList(filter) {
//                    
//                    list = filters_list.innerHTML;
//
//                    if(list !== '') {
//                        list += ' => '
//                    }
//
//                    list += filter
//
//                    filters_list.innerHTML = list
//                }
//
//                function resetFiltersList() {
//                    filters_list.innerHTML = '';
//                }
//
//                function requestFilter(filter) {
//                    return function(event) {
//                        postRequest('/applyFilter', filter)
//                            .then(response => response.json())
//                            .then(data => {
//
//                                img_array = data.img_array;
//                                view = brain_model.currentView;
//                                
//                                flipx = (view === 'side' || view ==='front')? true: false;
//                                flipy = (view === 'side')? true : false;
//                                updatePreprocessCanvas(data, flipx, flipy);
//                                addToFiltersList(this.value);
//                            })
//                            .catch(err => console.log(err));
//                        console.log(filter)
//                    }
//                }
//                median_filter.addEventListener('click', requestFilter('median'));
//                histo_filter.addEventListener('click', requestFilter('equalize'));
//                bilateral_filter.addEventListener('click', requestFilter('bilateral'))
//
//                isolate_brain.addEventListener('click', function(event){
//                    postRequest('/isolateBrain')
//                        .then(response=>response.json())
//                        .then(data => {
//
//                            view = brain_model.currentView;
//                            flipx = (view === 'side' || view ==='front')? true: false;
//                            flipy = (view === 'side')? true : false;
//                            updatePreprocessCanvas(data,flipx,flipy);
//                        })
//                        .catch(err => console.log(err));
//                });
//
//                reset_filters.addEventListener('click', function(event){
//
//                    postRequest('/resetPreprocessImage')
//                        .then(response => response.json())
//                        .then(data => {
//
//                            flipx = (view === 'side' || view ==='front')? true: false;
//                            flipy = (view === 'side')? true : false
//                            
//                            updatePreprocessCanvas(data, flipx, flipy);
//                            resetFiltersList();                            
//                        })
//                        .catch(err => console.log(err))
//                });
//
//            }
//
//            function initSegmentationFields() {
//
//                watershed_button = document.getElementById('watershed_button');
//                marker = document.getElementById('marker');
//                gradient = document.getElementById('gradient');
//                watershed = document.getElementById('watershed');
//
//                marker.draw = draw;
//                gradient.draw = draw;
//                watershed.draw = draw;
//
//                watershed_button.addEventListener('click', function(event){
//                    postRequest('/applyWatershed')
//                        .then(response => response.json())
//                        .then(data => {
//                            // console.log(data)
//                            view = brain_model.currentView;
//                            flipx = (view === 'side' || view ==='front')? true: false;
//                            flipy = (view === 'side')? true : false;
//                            marker.draw(data['marker'], 'grayscale', flipx, flipy);
//                            gradient.draw(data['gradient'], 'grayscale', flipx, flipy);
//                            watershed.draw(data['watershed'], 'grayscale', flipx, flipy);
//                            
//                        })
//                        .catch(err => console.log(err));
//                })
//
//            }
//
//            function draw(img_array, type='RGB', flipx=false, flipy=false) {
//               
//                var ctx = this.getContext('2d');
//                
//                var startx = (flipx)? img_array.length - 1 : 0;
//                var endx = (flipx)? 0 : img_array.length - 1;
//                var stepx = (flipx)? -1 : 1;
//
//                var starty = (flipy)? img_array[0].length - 1 : 0;
//                var endy = (flipy)? 0 : img_array[0].length -1;
//                var stepy = (flipy)? -1 : 1;
//
//                var imageWidth = img_array[0].length
//                var imageHeight = img_array.length
//                // change the size of the canvase depending on image array
//                // TODO, use scale, its better to have a static sized canvas 
//                // computation would be target / size of image array = scalar
//                // scalar can be used to scale
//
//                this.height = imageHeight;
//                this.width = imageWidth;
//
//                if(type === 'grayscale') {
//                    for (i=startx, x=0; i != endx; i+=stepx, x++){
//                        for(j=starty, y=0; j != endy;j+=stepy, y++){
//                            var color = img_array[i][j]
//                            ctx.fillStyle = "rgb("+color+","+color+","+color+")";
//                            ctx.fillRect(y, x, 1, 1);
//                        }
//                    }
//                } 
//                else if (type === 'RGB') {
//
//                }
//            }
//
//            
//            function postRequest(url, data={}) {
//                return fetch(url, {
//                    body: JSON.stringify(data),
//                    cache: 'no-cache',
//                    headers: {
//                        'content-type': 'application/json'
//                    },
//                    method: 'POST'
//                })
//            }
//            
//            function main(){
//
//                data = {{brain.data}};
//                dim = {{brain.dim}};
//                
//                brain_model.init();
//                brain_model.loadData(data);
//                
//                initPreprocessingFields();
//                initSegmentationFields();
//            }
//           
//            main();
//            
//            var canvas = document.getElementById("canvas1");
//            var slider = document.getElementById('myRange');
//            var numInput = document.getElementById("num");
//
//            var ctx = canvas.getContext('2d');
//            var slice = data[70];
//
//            var makeCanvas = function(array) {
//                canvas.width = array.length;
//                canvas.height = array[0].length;
//            }
//
//            var drawImg = function(array) {
//                for (i=0; i < array.length; i++) {
//                    for(j=0; j < array[i].length; j++) {
//                        var color = array[i][j];
//                        ctx.fillStyle = "rgb("+color+","+color+","+color+")";
//                        ctx.fillRect(j, i, 1, 1);
//                    }
//                }
//            }
//
//            var makeSlider = function(max) {
//                slider = document.getElementById('myRange');
//                slider.max = max;
//                numInput.value = slider.value;
//            }
//
//            slider.oninput = function() {
//                drawImg(data[this.value]);
//                numInput.value = this.value;
//            }
//            
//            numInput.oninput = function() {
//                drawImg(data[this.value]);
//                slider.value = this.value;
//            }
//
//            makeSlider(dim[0]);
//            makeCanvas(slice);
//            drawImg(slice);
        </script>
    </body>
</html>